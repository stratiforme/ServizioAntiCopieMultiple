name: Publish Windows artifacts

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  publish:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore
        run: dotnet restore ServizioAntiCopieMultiple.sln

      - name: Build
        run: dotnet build ServizioAntiCopieMultiple.sln -c Release --no-restore

      - name: Publish ServizioAntiCopieMultiple -> artifacts/publish/ServizioAntiCopieMultiple
        run: |
          dotnet publish ServizioAntiCopieMultiple/ServizioAntiCopieMultiple.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -p:PublishTrimmed=true -o artifacts/publish/ServizioAntiCopieMultiple

      - name: Publish GestioneSACM -> artifacts/publish/GestioneSACM
        run: |
          dotnet publish GestioneSACM/GestioneSACM.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -p:PublishTrimmed=true -o artifacts/publish/GestioneSACM

      - name: List published files
        run: dir artifacts\publish || echo "No published files"

      - name: Create zip of published artifacts (executables at zip root)
        run: |
          if (-Not (Test-Path artifacts)) { New-Item -ItemType Directory -Path artifacts | Out-Null }
          if (-Not (Test-Path artifacts\publish)) { Write-Error 'Publish folder not found'; exit 1 }
          $zipName = "release-${{ github.ref_name }}-windows-x64.zip"
          $zipPath = Join-Path "artifacts" $zipName
          # Compress the *contents* of 'artifacts/publish' so the zip contains files/folders at the root (no extra top-level folder)
          Push-Location artifacts\publish
          Compress-Archive -Path * -DestinationPath "..\$zipName" -Force
          Pop-Location

      - name: Generate SHA256 checksum for release zip
        run: |
          $zipName = "release-${{ github.ref_name }}-windows-x64.zip"
          $zipPath = Join-Path "artifacts" $zipName
          if (-Not (Test-Path $zipPath)) { Write-Error 'Zip file not found'; exit 1 }
          $hash = Get-FileHash -Algorithm SHA256 $zipPath
          $outFile = "$zipPath.sha256"
          ($hash.Hash + '  ' + (Split-Path $zipPath -Leaf)) | Out-File -FilePath $outFile -Encoding ASCII

      - name: Upload release zip and checksum
        uses: actions/upload-artifact@v4
        with:
          name: release-windows-zip
          path: |
            artifacts/release-${{ github.ref_name }}-windows-x64.zip
            artifacts/release-${{ github.ref_name }}-windows-x64.zip.sha256

      - name: Create Release (on tag)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          # include only the single zip and its checksum
          files: |
            artifacts/release-${{ github.ref_name }}-windows-x64.zip
            artifacts/release-${{ github.ref_name }}-windows-x64.zip.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
